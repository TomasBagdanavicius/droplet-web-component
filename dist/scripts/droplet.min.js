/*! Droplet v1.0.1 */
import{Breadcrumbs}from"./breadcrumbs.min.js";import{Progress}from"./progress.min.js";class Droplet extends HTMLElement{constructor(){for(var t in super(),this.shadow=this.attachShadow({mode:"open"}),this.shadow.host.classList.add("d-js-init"),this.wrapper=this.shadow.host,this.o=Droplet.getDefaultOptions(),this.dataset)this.o.hasOwnProperty(t)&&(this.o[t]=Droplet.convertStringValueToType(this.dataset[t]));if(this.playing=!1,this.history=[],this.actionHistoryCount=0,this.actionHistory=[],this.defer=[],this.request,this.progress=Progress.createElement(),this.bar,this.breadcrumbs,this.effectNames=["d-film-track","d-slide-over","d-cross-fade"],this.effectDirections=["d-anim-top","d-anim-right","d-anim-bottom","d-anim-left"],this.elemTitle,this.createElements(),this.wrapper.setAttribute("data-level","0"),this.shadow.appendChild(this.progress.wrapper),!this.o.defaultEffect){const e=[];[...this.effectNames,...this.effectDirections].forEach(t=>{this.wrapper.classList.contains(t)&&e.push(t)}),e.length&&(this.o.defaultEffect=e.join(" "))}this.o.captureInsideLinks&&this.bindToHyperlinks(this.activeElement),this.bindGlobalEvents()}static getDefaultOptions(){return{captureInsideLinks:!0,useLinkTitles:!1,defaultEffect:null,returnOppositeDirection:!0,showMenuBar:"breadcrumbs",requestTimeout:1e4,stylesheet:"css/droplet.min.css",defaultFragment:"content",variableHeight:!0,homeButtonText:"Home",homeButtonTitle:"Go to the Home card",backButtonText:"Back",backButtonTitle:"Go back",onEnd:null}}static convertStringValueToType(t){return"true"===t?t=!0:"false"===t?t=!1:"null"===t?t=null:/^[\d\.]+$/.test(t)&&(t=parseFloat(t)),t}createUniqueElemId(t="e"){let e=0;for(;this.shadow.getElementById("e"+e);)e++;return t+e}createInnerWrapper(t,e,i=!0){for(;t.firstChild;)e.appendChild(t.firstChild);i&&t.appendChild(e)}createElements(){var t=document.createElement("div"),t=(this.createInnerWrapper(this.shadow.host,t,!1),this.inner=document.createElement("div"),this.inner.classList.add("inn"),this.pane=document.createElement("div"),this.pane.classList.add("pane"),this.activeElement=document.createElement("div"),this.activeElement.classList.add("i","act","on"),this.pane.appendChild(this.activeElement),this.inner.appendChild(this.pane),this.createInnerWrapper(t,this.activeElement,!1),document.createElement("link")),t=(t.setAttribute("rel","stylesheet"),t.setAttribute("href",this.o.stylesheet),t.setAttribute("type","text/css"),t.addEventListener("load",()=>{var t;new URL(this.o.stylesheet,location.href).href,this.o.variableHeight||(t=getComputedStyle(this.wrapper).getPropertyValue("max-height"))&&"none"!=t&&(t=parseInt(t),isNaN(t)||0<=(t=t-this.wrapper.offsetHeight)&&(this.inner.style.height=this.inner.offsetHeight+t+"px"))}),this.shadow.appendChild(t),this.shadow.appendChild(this.inner),this.createUniqueElemId()),e={id:this.activeElement.id=t};let i;if(this.wrapper.hasAttribute("data-title")&&(i=this.wrapper.getAttribute("data-title"),this.wrapper.removeAttribute("data-title"),this.activeElement.setAttribute("data-title",i),this.elemTitle=e.title=i),this.history.push(e),this.o.showMenuBar&&this.wrapper.classList.add("d-with-bar"),"breadcrumbs"===this.o.showMenuBar){if(this.addBreadcrumbBar(),i){const r=this.breadcrumbs.createListItemWithHyperlink(i,"#"+t,["act"]);r.setAttribute("data-ref-id",t),r.setAttribute("title",i),r.addEventListener("click",t=>{t.preventDefault(),this.actionHistory.length?this.goHome():this.request&&(this.terminateRequest(),this.wrapper.classList.remove("d-non-root")),this.itemFlash(r)})}}else"navigation"===this.o.showMenuBar&&this.addNavigationBar(i)}addNavigationBar(t){var e,i=document.createElement("div");i.classList.add("menu-bar");let r=document.createElement("button"),s=(r.appendChild(document.createTextNode(this.o.homeButtonText)),r.setAttribute("type","button"),r.classList.add("home"),r.title=this.o.homeButtonTitle,document.createElement("button"));s.appendChild(document.createTextNode(this.o.backButtonText)),r.setAttribute("type","button"),s.classList.add("back"),s.title=this.o.backButtonTitle,r.addEventListener("click",t=>{this.itemFlash(r),this.goHome()},!1),s.addEventListener("click",t=>{this.itemFlash(s),this.goBackByOne()},!1),t&&((e=document.createElement("span")).appendChild(document.createTextNode(t)),e.classList.add("t"),i.appendChild(e),e.addEventListener("click",t=>{t.preventDefault(),this.reload()})),i.appendChild(s),i.appendChild(r),this.shadow.appendChild(i),this.bar=i}addBreadcrumbBar(){var t;this.breadcrumbs||(t=this.createBreadcrumbs(),(t=this.shadow.appendChild(t.el)).classList.add("menu-bar"),this.bar=t)}itemFlash(t){t.classList.add("flash"),setTimeout(()=>{t.classList.remove("flash")},250)}isPlaying(){return this.playing}createBreadcrumbs(){return this.breadcrumbs=Breadcrumbs.create(),this.breadcrumbs}getDirection(t){if(this.playing){var t=getComputedStyle(t),e=parseFloat(t.getPropertyValue("top")),i=parseFloat(t.getPropertyValue("left"));if(parseFloat(t.getPropertyValue("right")),parseFloat(t.getPropertyValue("bottom")),0==e&&0==i)return!1;if(e<0)return"bottom";if(i<0)return"right";if(parseFloat(t.getPropertyValue("right"))<0&&0==e)return"left";if(parseFloat(t.getPropertyValue("bottom"))<0&&0==i)return"top"}return!1}static getAxisByDirection(t){return"top"==t||"bottom"==t?"y":("right"==t||"left"==t)&&"x"}static getOppositeDirection(t){return"top"==t?"bottom":"right"==t?"left":"bottom"==t?"top":"left"==t?"right":void 0}resetAnimClasses(){this.wrapper.classList.remove(...this.effectNames,...this.effectDirections)}parseAnimClasses(i){let r={transitions:[],direction:null};if("string"==typeof i&&""!=i&&"none"!=i){const s=i.toLowerCase().split(/\s+/);var t=s.includes("d-film-track"),e=s.includes("d-slide-over");if(t&&e)throw new Error("Film-track and slide-over effects cannot be used together.");s.forEach((t,e)=>{this.effectDirections.includes(t)?r.direction?console.error('Direction effect cannot be used multiple times. Will ignore "'+t+'".'):(s.splice(e,1),r.direction=t):-1===this.effectNames.indexOf(t)&&console.error('Unrecognized effect name "'+t+'" in "'+i+'".')}),r.transitions=s}return r}addAnimClasses(t){this.resetAnimClasses(),this.wrapper.classList.add(...t.transitions),t.direction&&this.wrapper.classList.add(t.direction)}effectObjectToAnimClassesStr(t,e=!1){let i="none";return t.transitions.length&&(i=t.transitions.join(" ")),i=t.direction?i+" "+(e?"d-anim-"+Droplet.getOppositeDirection(t.direction.substr(7)):t.direction):i}initTransition(e,t,i=0,r=!1){""!=t&&"none"!=t||!this.o.defaultEffect||(t=this.o.defaultEffect),(t=this.parseAnimClasses(t)).transitions.length?this.addAnimClasses(t):this.resetAnimClasses(),this.o.variableHeight&&(this.inner.style.height=this.inner.offsetHeight+"px");e.offsetWidth;e.classList.add("act"),this.wrapper.classList.add("d-play"),this.playing=!0;var s=this.getDirection(e),a="transform"===getComputedStyle(this.pane).getPropertyValue("transition-property").substr(0,9),n=getComputedStyle(e).getPropertyValue("transition-property"),o="transform"===n.substr(0,9),n="opacity"===n.substr(-7);if(r||(h=[],a?h.push("d-film-track"):o&&h.push("d-slide-over"),n&&h.push("d-cross-fade"),this.actionHistory.push({transitions:h,direction:s?"d-anim-"+s:null})),s){var h=Droplet.getAxisByDirection(s);let t;t="top"==s||"left"==s?"x"==h?Math.min(this.activeElement.offsetWidth,window.innerWidth):Math.min(this.activeElement.offsetHeight,window.innerHeight):"x"==h?Math.min(e.offsetWidth,window.innerWidth):Math.min(e.offsetHeight,window.innerHeight);s="left"==s||"top"==s?"-":"";a&&(this.pane.style.transform="translate"+h.toUpperCase()+"("+s+t+"px)"),o&&(e.style.transform="translate"+h.toUpperCase()+"("+s+t+"px) scale(1)")}if(this.defer={relocated:r,effect:t,isFilmTrack:a,isSlide:o,isCrossFade:n},r?(this.defer.reduceNumber=i,this.actionHistoryCount=this.actionHistoryCount-i,this.actionHistory.splice(-i,i),this.history.splice(-i,i),this.history,this.bar&&!this.breadcrumbs&&this.setMenuBarTitle(e.getAttribute("data-title"))):this.actionHistoryCount++,this.wrapper.setAttribute("data-level",this.actionHistoryCount),this.actionHistoryCount?this.wrapper.classList.add("d-non-root"):this.wrapper.classList.remove("d-non-root"),this.o.variableHeight&&(this.inner.style.height=Math.min(e.offsetHeight,window.innerHeight)+"px"),this.actionHistory,this.history,i)for(let t=i;1<=t;t--){var l=this.pane.children[t];l.classList.contains("on")||l.classList.remove("act"),"breadcrumbs"==this.o.showMenuBar&&(l=this.breadcrumbs.list.querySelector('[data-ref-id="'+l.id+'"]'))&&l.classList.remove("act")}h=new Promise((t,e)=>{this.defer.resolution=[t,e]});return a||n||o||this.completeTransition(),h}completeTransition(){this.defer,this.wrapper.classList.remove("d-play"),this.playing=!1,this.activeElement.classList.remove("on","act");var t=this.pane.children[0];if(t.classList.add("on"),"function"==typeof this.o.onEnd&&this.o.onEnd.call(this,this.newItem,this.activeElement),this.activeElement=t,this.o.variableHeight&&(this.inner.style.height=""),this.defer.isFilmTrack&&(this.pane.style.transform=""),this.defer.isSlide&&(this.newItem.style.transform=""),this.defer.reduceNumber)for(let t=this.defer.reduceNumber;1<=t;t--){var e=this.pane.children[t],i=e.id;e.remove(),"breadcrumbs"==this.o.showMenuBar&&(e=this.breadcrumbs.list.querySelector('[data-ref-id="'+i+'"]'))&&e.remove()}this.defer&&this.defer.resolution[0](),this.newItem=null}createItemElement(){var t=document.createElement("div");return t.classList.add("i"),t.id=this.createUniqueElemId(),t}bindToHyperlinks(t){for(let s of t.getElementsByTagName("a"))s.addEventListener("click",r=>{if(!s.classList.contains("d-prevent")&&!s.getAttribute("target")){var t=s.getAttribute("href");if(""!=t&&"#"!=t.charAt(0)){r.preventDefault();let t="none",e=(s.hasAttribute("data-effect")&&""!=s.getAttribute("data-effect")&&(t=s.getAttribute("data-effect")),s.href),i=null;s.hash&&(e=s.href.substr(0,s.href.length-s.hash.length),i=s.hash.substr(1)),this.populateContentFromURL(e,i,t,s.innerText)}else"#back"==t?(r.preventDefault(),this.goBackByOne()):"#home"==t&&(r.preventDefault(),this.goHome())}})}getBreadcrumbMaxWidth(t){var e=getComputedStyle(t).getPropertyValue("max-width");return Math.min("none"!=e?parseFloat(e):100,Math.ceil(t.firstElementChild.getBoundingClientRect().width))}createInitialBreadcrumbItem(t){if("breadcrumbs"==this.o.showMenuBar)return this.addBreadcrumbBar(),(t=this.breadcrumbs.createListItemWithHyperlink("Loading...",t,["load"],!0)).offsetWidth,t.classList.add("act"),t}populateInitialBreadcrumb(t){"breadcrumbs"==this.o.showMenuBar&&("string"==typeof t&&this.setMenuBarTitle(t),t=this.getBreadcrumbMaxWidth(this.currentBreadcrumbItem),this.currentBreadcrumbItem.style.setProperty("--item-max-width",t+"px"),this.currentBreadcrumbItem.classList.remove("load"))}populateContent(t,e,r,s,i){!s&&this.request&&this.terminateRequest();let a=this.createItemElement();if(this.pane.insertBefore(a,this.activeElement),a.insertAdjacentHTML("afterbegin",t),a.setAttribute("data-title",e),this.elemTitle=e,this.newItem=a,this.o.captureInsideLinks&&this.bindToHyperlinks(a),i?this.history.push(i):this.history.push({title:e}),"breadcrumbs"==this.o.showMenuBar){const n=this.actionHistoryCount+1;s||(this.addBreadcrumbBar(),s=this.breadcrumbs.createListItemWithHyperlink(e,"#"+a.id,[],!0),t=this.getBreadcrumbMaxWidth(s),s.classList.add("act"),s.style.setProperty("--item-max-width",t+"px"),s.setAttribute("data-ref-id",a.id),this.currentBreadcrumbItem=s),s.setAttribute("data-ref-id",a.id),s.setAttribute("title",e),s.addEventListener("click",i=>{if(!this.request||this.request&&this.currentBreadcrumbItem!==s){i.preventDefault(),n;i=this.currentBreadcrumbItem!==s&&this.actionHistory.length-1>=n?this.effectObjectToAnimClassesStr(this.actionHistory[n],!0):"none",i=(this.goBack(a.id,i),s.firstElementChild);if("#"!=i.getAttribute("href").charAt(0)){s.classList.add("load");let t=i.href,e=null;i.hash&&(t=i.href.substr(0,i.href.length-i.hash.length),e=i.hash.substr(1)),this.populateContentFromURL(t,e,r,s.innerText,s)}}this.itemFlash(s)})}else this.setMenuBarTitle(e);return this.initTransition(a,r)}setMenuBarTitle(t){var e;this.breadcrumbs?(this.currentBreadcrumbItem.firstElementChild.innerText=t,this.currentBreadcrumbItem.setAttribute("title",t)):this.bar&&((e=this.bar.getElementsByClassName("t")[0]).textContent=t,e.setAttribute("title",t))}putContent(t,e){var i=this.pane.children[0];i.innerHTML=t,this.setMenuBarTitle(e),this.o.captureInsideLinks&&this.bindToHyperlinks(i)}reload(){var t=this.history[this.history.length-1];if(t.hasOwnProperty("url"))return this.populateContentFromURL(t.url,t.fragment,"none")}async populateContentFromURL(t,e,i,r,s){if(!s&&this.playing)throw new Error("Request blocked: it is currently playing.");this.request&&this.terminateRequest();var a=new AbortController;let n=setTimeout(()=>{this.terminateRequest()},this.o.requestTimeout);var o={url:t,timeout:this.o.requestTimeout,abortController:a,timeoutCallback:n};const h={url:t,fragment:e};var l=this.history[this.history.length-1];let d=!(l.hasOwnProperty("url")&&l.url==t&&(!e||l.hasOwnProperty("fragment")&&e==l.fragment));if("breadcrumbs"==this.o.showMenuBar){d&&!s?s=this.createInitialBreadcrumbItem(t+(e?"#"+e:"")):s?d=!1:s=this.currentBreadcrumbItem;const c=t=>{t.preventDefault(),this.terminateRequest(!d),d||this.populateInitialBreadcrumb(),s.removeEventListener("click",c)};s.addEventListener("click",c),o.breadcrumbItem=s,o.breadcrumbAbortEvent=c,this.currentBreadcrumbItem=s}return this.request=o,this.progress instanceof Progress&&(l=Progress.generateRandomNumbers(Progress.randomBetweenTwoNumbers(90,99),10),this.progress.progressPlanTo(l,this.o.requestTimeout)),Droplet.loadContent(t,e??this.o.defaultFragment,a).then(t=>{this.request,clearTimeout(n),this.progress instanceof Progress&&this.progress.complete(this.getCSSSpeed()),"breadcrumbs"==this.o.showMenuBar&&this.request.hasOwnProperty("breadcrumbAbortEvent")&&this.currentBreadcrumbItem.removeEventListener("click",this.request.breadcrumbAbortEvent),this.request=null;var e=this.o.useLinkTitles&&r?r:t[0];h.title=e,"breadcrumbs"==this.o.showMenuBar&&this.populateInitialBreadcrumb(e),d?this.populateContent(t[1],e,i,this.currentBreadcrumbItem,h):(this.putContent(t[1],e),this.wrapper.classList.add("d-flash"),setTimeout(()=>{this.wrapper.classList.remove("d-flash")},100))}).catch(t=>{console.error("Populate content from URL error: "+t.message),t instanceof DOMException&&"AbortError"===t.name||this.terminateRequest()})}getCSSSpeed(){return 1e3*parseFloat(getComputedStyle(this.wrapper).getPropertyValue("--speed"))}terminateRequest(t=!1){if(this.request){if(clearTimeout(this.request.timeoutCallback),this.request.abortController.signal.aborted||this.request.abortController.abort(),"breadcrumbs"==this.o.showMenuBar&&!t){this.currentBreadcrumbItem.classList.remove("act","load");const e=this.currentBreadcrumbItem;setTimeout(()=>{e&&e.parentNode&&e.parentNode===this.breadcrumbs.list&&this.breadcrumbs.list.removeChild(e)},this.getCSSSpeed())}this.progress instanceof Progress&&this.progress.revert(),this.request=null}}static async loadContent(t,o,e){var i=new Headers;i.append("Cache-Control","no-store");let r,h;return fetch(t,{signal:e.signal,headers:i}).then(t=>{if((r=t.headers.get("Content-Type")).startsWith("text/html"))return h="text/html",t.text();if(r.startsWith("application/json"))return h="application/json",t.json();if(r.startsWith("text/plain"))return h="text/plain",t.text();throw Error("Unrecognized content type.")}).then(e=>{let i="",t,r;function s(t){return t.replace(/[\t]/gm,"").replace(/[\r\n]+/gm," ").split(/\s+/).slice(0,3).join(" ")}var a,n;if("object"==typeof e){if(e.title)i=e.title;else{let t;for(t in e)break;t&&(i=t+": "+e[t])}t="string"==typeof o&&e.hasOwnProperty(o)?e[o]:JSON.stringify(e)}else"text/html"==h?(a=(new DOMParser).parseFromString(e,"text/html"),t=(t="string"==typeof o&&(r=a.getElementById(o))?r.innerHTML:t)||e,n=a.getElementsByTagName("title"),i=n.length?n[0].innerText:s((r||a.body).textContent)):(n=Math.max(e.indexOf("\r"),e.indexOf("\n")),t=(0<=n?(i=e.substring(0,n).trim(),e.substring(n)):e).trim(),""==i&&""!=t&&(i=s(t)),""!=t&&(t="<p>"+t.replace(/(\r?\n){2,}/gm,"</p><p>").replace(/(\r?\n){1}/gm,"<br>").replace(/\[([^\]]+)\]\(([^\)]+)\)/,'<a href="$2">$1</a>')+"</p>"));return[i,t]}).catch(t=>{throw console.error("Load content error: "+t.message),t})}goBack(e,t="none"){let i=0;if(this.request&&this.terminateRequest(),this.playing)throw new Error("Request blocked: it is currently playing.");let r;if("number"==typeof e){if(this.pane.children.length-1<e)return null;i+=e,r=this.pane.children[e]}else if("string"==typeof e){var s=this.pane.children.length;let t;for(t=0;t<s;t++)if(this.pane.children[t].id==e){r=this.pane.children[t];break}if(!r)return null;i+=t}var a;return this.activeElement===r?null:(a=r.parentNode.removeChild(r),a=this.pane.insertBefore(a,this.pane.children[0]),this.newItem=a,this.initTransition(a,t,i,!0))}goBackByOne(){if(this.actionHistoryCount)return this.goBack(1,this.effectObjectToAnimClassesStr(this.actionHistory[this.actionHistoryCount-1],!0))}goHome(){if(this.actionHistoryCount)return this.goBack(this.actionHistoryCount,this.effectObjectToAnimClassesStr(this.actionHistory[0],!0))}getActionHistoryCount(){return this.actionHistoryCount}bindGlobalEvents(){this.pane.addEventListener("transitionend",t=>{(t.target===this.pane&&"transform"==t.propertyName||t.target===this.activeElement&&"opacity"==t.propertyName||t.target===this.newItem&&"transform"==t.propertyName)&&this.playing&&(t.propertyName,t.target,this.completeTransition())})}}export{Droplet};